name: Build æ–°R30B1

on:
  workflow_dispatch:
    inputs:
      profile:
        type: choice
        description: "è¯·é€‰æ‹©mtkè·¯ç”±å™¨åž‹å·"
        required: true
        options:
          - cmcc_rax3000m-nand
          - sl_3000-emmc
        default: cmcc_rax3000m-nand
      custom_router_ip:
        description: "è¯·è®¾ç½®è·¯ç”±å™¨çš„ç®¡ç†åœ°å€ æ ¼å¼:192.168.x.1"
        required: true
        default: "192.168.6.1"
      enable_store:
        description: "é›†æˆ store å•†åº—"
        required: false
        type: boolean
        default: true
      include_docker:
        description: "æ˜¯å¦ç¼–è¯‘ Docker æ’ä»¶"
        required: true
        default: 'no'
        type: choice
        options:
          - 'yes'
          - 'no'
      enable_pppoe:
        description: "æ˜¯å¦é…ç½®PPPoEæ‹¨å·ä¿¡æ¯?"
        required: true
        default: 'no'
        type: choice
        options:
          - 'yes'
          - 'no'
      pppoe_account:
        description: "å®½å¸¦è´¦å· (è‹¥å¯ç”¨PPPoE)"
        required: false
      pppoe_password:
        description: "å®½å¸¦å¯†ç  (è‹¥å¯ç”¨PPPoE)"
        required: false

env:
  KWRT_VERSION: "24.10"
  KWRT_PACKAGE_VERSION: "24.10.4"
  IMAGE_BUILDER_DIR: ""
  BUILD_TARGET_DIR: ""
  PLATFORM: ""

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget zstd tree rsync

      - name: Save Custom Router IP
        run: |
          mkdir -p "${{ github.workspace }}/custom"
          echo "${{ github.event.inputs.custom_router_ip }}" > "${{ github.workspace }}/custom/custom_router_ip.txt"
          echo "âœ… è·¯ç”±å™¨ç®¡ç†åœ°å€: ${{ github.event.inputs.custom_router_ip }}"

      - name: Validate PPPoE Inputs
        run: |
          # å°† input æ˜ å°„åˆ° env é¿å…è¯­æ³•é”™è¯¯
          if [[ "${{ inputs.enable_pppoe }}" == "yes" ]]; then
            if [[ -z "${{ inputs.pppoe_account }}" || -z "${{ inputs.pppoe_password }}" ]]; then
              echo "âŒ Error: PPPoE account and password must be provided!"
              exit 1
            fi
          fi

      - name: Enable Store integration
        run: |
          if [ "${{ github.event.inputs.enable_store }}" == "true" ]; then
            mkdir -p shell
            echo 'CUSTOM_PACKAGES="$CUSTOM_PACKAGES luci-app-store"' >> shell/custom-packages.sh

            echo 'CUSTOM_PACKAGES="$CUSTOM_PACKAGES -luci-app-qos"' >> shell/custom-packages.sh
            echo 'CUSTOM_PACKAGES="$CUSTOM_PACKAGES -luci-app-statistics"' >> shell/custom-packages.sh
            echo 'CUSTOM_PACKAGES="$CUSTOM_PACKAGES -luci-app-homeproxy"' >> shell/custom-packages.sh
            echo 'CUSTOM_PACKAGES="$CUSTOM_PACKAGES -luci-app-dockerman"' >> shell/custom-packages.sh

            
            echo "âœ… å·²è¿½åŠ  luci-app-store"
          else
            echo "âŽ æœªå¯ç”¨ luci-app-store"
          fi

      - name: Determine platform and download URL
        id: setup
        run: |
          profile="${{ github.event.inputs.profile }}"
          echo "ðŸ”§ Building for profile: $profile"
          
          # é»˜è®¤å¹³å° (é€‚é… sl_3000-emmc)
          platform="mediatek/filogic"
          # æ³¨æ„ï¼šæ­¤å¤„ä½¿ç”¨ä½ æŒ‡å®šçš„ç‰¹å®š KWRT ç‰ˆæœ¬é“¾æŽ¥
          download_url="https://github.com/1303045940/Kwrt/releases/download/12%2F05_2025_23%2F26_mediatek_filogic/kwrt-imagebuilder-mediatek-filogic.Linux-x86_64.tar.zst"
          #download_url="https://github.com/a1303045940/Kwrt/releases/download/12%2F05_2025_14%2F07_mediatek_filogic/kwrt-imagebuilder-mediatek-filogic.Linux-x86_64.tar.zst"
          download_url="https://github.com/a1303045940/Kwrt/releases/download/12%2F05_2025_14%2F06_mediatek_filogic/kwrt-imagebuilder-mediatek-filogic.Linux-x86_64.tar.zst"
          # å…¼å®¹å…¶ä»–æœºåž‹çš„åˆ¤æ–­é€»è¾‘ (ä¿ç•™ä¸åŠ¨)
          if [ -f model/ipq807x.txt ]; then
            ipq807x_models=$(cat model/ipq807x.txt | tr '\n' '|')
            ipq807x_models=${ipq807x_models%|}
            if [[ "$profile" =~ ^($ipq807x_models)$ ]]; then
              platform="qualcommax/ipq807x"
              download_url="https://dl.openwrt.ai/releases/${{ env.KWRT_VERSION }}/targets/qualcommax/ipq807x/kwrt-imagebuilder-qualcommax-ipq807x.Linux-x86_64.tar.zst"
            fi
          fi
          
          # è¾“å‡ºçŽ¯å¢ƒå˜é‡
          echo "platform=$platform" >> $GITHUB_ENV
          echo "PLATFORM=$platform" >> $GITHUB_ENV
          echo "download_url=$download_url" >> $GITHUB_ENV
          echo "ðŸ“¦ Platform: $platform"
          echo "ðŸ”— Download URL: $download_url"

      - name: Download and extract Kwrt ImageBuilder
        run: |
          echo "â¬‡ï¸ Downloading ImageBuilder..."
          wget -q --show-progress ${{ env.download_url }}
          
          filename=$(basename ${{ env.download_url }})
          echo "ðŸ“¦ Extracting $filename..."
          
          if [[ "$filename" =~ \.tar\.gz$ ]]; then
            tar -xzf "$filename"
          elif [[ "$filename" =~ \.tar\.zst$ ]]; then
            tar --zstd -xf "$filename"
          else
            echo "âŒ ä¸æ”¯æŒçš„æ ¼å¼"
            exit 1
          fi
          
          builder_dir=$(tar --zstd -tf $filename | head -1 | cut -f1 -d"/")
          echo "IMAGE_BUILDER_DIR=$builder_dir" >> $GITHUB_ENV
          echo "BUILD_TARGET_DIR=$builder_dir/bin/targets/${{ env.PLATFORM }}" >> $GITHUB_ENV
          echo "âœ… ImageBuilder å·²è§£åŽ‹åˆ°: $builder_dir"

      - name: Prepare custom files
        run: |
          cd ${{ env.IMAGE_BUILDER_DIR }}
          
          echo "================================================"
          echo "å‡†å¤‡è‡ªå®šä¹‰æ–‡ä»¶å’Œé…ç½®"
          echo "================================================"
          
          # 1. åˆ›å»ºåŸºç¡€ç›®å½•ç»“æž„
          mkdir -p files/etc/uci-defaults files/etc/config files/etc/opkg
          
          # 2. æ ¸å¿ƒåŠŸèƒ½ï¼šå¤åˆ¶ custom-files ç›®å½•
          #    è¿™å°†æŠŠ custom-files ä¸‹çš„æ‰€æœ‰æ–‡ä»¶è¦†ç›–åˆ° ImageBuilder çš„ files/ ç›®å½•
          if [ -d "${{ github.workspace }}/custom-files" ]; then
            echo "ðŸ“‚ å‘çŽ° custom-files ç›®å½•ï¼Œå¼€å§‹å¤åˆ¶..."
            rsync -hav --exclude='.*' --exclude='*.md' \
              ${{ github.workspace }}/custom-files/ files/
            echo "âœ… custom-files å·²åˆå¹¶"
          else
            echo "âš ï¸ æœªæ‰¾åˆ° custom-files ç›®å½•ï¼Œè·³è¿‡åˆå¹¶"
          fi
          
          # 3. åŠ¨æ€ç”Ÿæˆ PPPoE é…ç½® (è¦†ç›–åŽŸæœ‰é…ç½®)
          echo "ðŸ“ åˆ›å»º PPPoE é…ç½®æ–‡ä»¶..."
          cat > files/etc/config/pppoe-settings << 'EOF'
          enable_pppoe=${{ github.event.inputs.enable_pppoe }}
          pppoe_account=${{ github.event.inputs.pppoe_account }}
          pppoe_password=${{ github.event.inputs.pppoe_password }}
          EOF
          
          # 4. ä¿å­˜è·¯ç”±å™¨ IP (è¦†ç›–åŽŸæœ‰é…ç½®)
          echo "ðŸ“ ä¿å­˜è·¯ç”±å™¨ IP é…ç½®..."
          echo "${{ github.event.inputs.custom_router_ip }}" > files/etc/config/custom_router_ip.txt
          
          # 5. å¤åˆ¶è¡¥å……é…ç½® (å¦‚æžœå­˜åœ¨)
          if [ -d "${{ github.workspace }}/glinet" ]; then
             rsync -hav ${{ github.workspace }}/glinet/ files/etc/uci-defaults/
             echo "âœ… å·²åˆå¹¶ glinet é…ç½®"
          fi
          
          if [ -f "${{ github.workspace }}/arch/arch.conf" ]; then
             cp ${{ github.workspace }}/arch/arch.conf files/etc/opkg/arch.conf
             echo "âœ… å·²å¤åˆ¶ arch.conf"
          fi
          
          # 6. å±•ç¤ºæœ€ç»ˆæ–‡ä»¶ç»“æž„
          echo "================================================"
          echo "ðŸ“‚ æœ€ç»ˆ files ç›®å½•ç»“æž„:"
          tree files/ || find files -type f -ls
          echo "================================================"

      - name: é¢„ç½® OpenClash å†…æ ¸å’Œæ•°æ®
        run: |
          cd ${{ env.IMAGE_BUILDER_DIR }}
          
          # ... (å‰ç•¥ï¼šè¿™é‡Œæ˜¯ä½ åŽŸæœ¬çš„ mkdir, rsync, pppoe é…ç½®ç­‰ä»£ç ) ...

          # =======================================================
          # [æ–°å¢ž] é¢„ç½® OpenClash å†…æ ¸å’Œæ•°æ® (é€‚é… ImageBuilder)
          # =======================================================
          echo "ðŸŒ å¼€å§‹é¢„ç½® OpenClash å†…æ ¸ä¸Žåœ°ç†æ•°æ®..."
          
          # 1. ç¡®å®šç›®æ ‡ç›®å½• (ImageBuilder æ¨¡å¼ä¸‹å¿…é¡»æ”¾åœ¨ files/ ä¸‹)
          OC_ROOT="files/etc/openclash"
          OC_CORE_DIR="$OC_ROOT/core"
          mkdir -p "$OC_CORE_DIR"
          
          # 2. åˆ¤æ–­æž¶æž„ (é’ˆå¯¹ä½ çš„ sl_3000-emmc / filogicï¼Œå›ºå®šä¸º arm64)
          # å¦‚æžœæœªæ¥æž„å»º x86ï¼Œå¯ä»¥ç”¨ if [[ "${{ env.PLATFORM }}" == *"x86"* ]]; then ...
          CORE_TYPE="arm64"
          echo "âš™ï¸ è¯†åˆ«æž¶æž„ä¸º: $CORE_TYPE"

          # 3. å®šä¹‰ä¸‹è½½é“¾æŽ¥
          CORE_VER_URL="https://raw.githubusercontent.com/vernesong/OpenClash/core/dev/core_version"
          # èŽ·å– TUN ç‰ˆæœ¬å·
          CORE_TUN_VER=$(curl -sL $CORE_VER_URL | sed -n "2{s/\r$//;p;q}")
          
          CORE_MATE_URL="https://github.com/vernesong/OpenClash/raw/core/dev/meta/clash-linux-$CORE_TYPE.tar.gz"
          GEO_MMDB_URL="https://github.com/alecthw/mmdb_china_ip_list/raw/release/lite/Country.mmdb"
          GEO_SITE_URL="https://github.com/Loyalsoldier/v2ray-rules-dat/raw/release/geosite.dat"
          
          # 4. ä¸‹è½½æ•°æ®æ–‡ä»¶
          echo "â¬‡ï¸ ä¸‹è½½ GeoIP/GeoSite æ•°æ®..."
          curl -sL -o "$OC_ROOT/Country.mmdb" "$GEO_MMDB_URL" && echo "âœ… Country.mmdb done"
          curl -sL -o "$OC_ROOT/GeoSite.dat" "$GEO_SITE_URL" && echo "âœ… GeoSite.dat done"
          
          # 5. ä¸‹è½½å¹¶è§£åŽ‹å†…æ ¸ (Meta å†…æ ¸é€šå¸¸æœ€å¸¸ç”¨)
          echo "â¬‡ï¸ ä¸‹è½½ Meta å†…æ ¸..."
          curl -sL -o "$OC_CORE_DIR/meta.tar.gz" "$CORE_MATE_URL"
          
          if [ -f "$OC_CORE_DIR/meta.tar.gz" ]; then
            tar -zxf "$OC_CORE_DIR/meta.tar.gz" -C "$OC_CORE_DIR"
            mv -f "$OC_CORE_DIR/clash" "$OC_CORE_DIR/clash_meta"
            rm -f "$OC_CORE_DIR/meta.tar.gz"
            chmod +x "$OC_CORE_DIR/clash_meta"
            echo "âœ… Meta å†…æ ¸é¢„ç½®å®Œæˆ"
          else
            echo "âŒ Meta å†…æ ¸ä¸‹è½½å¤±è´¥"
          fi
          
          # (å¯é€‰) ä¸‹è½½ Tun å†…æ ¸ï¼Œå¦‚æžœç©ºé—´å¤Ÿå¤§çš„è¯ï¼Œå–æ¶ˆä¸‹é¢æ³¨é‡Š
          # CORE_TUN_URL="https://github.com/vernesong/OpenClash/raw/core/dev/premium/clash-linux-$CORE_TYPE-$CORE_TUN_VER.gz"
          # curl -sL -o "$OC_CORE_DIR/tun.gz" "$CORE_TUN_URL"
          # gzip -d "$OC_CORE_DIR/tun.gz"
          # mv -f "$OC_CORE_DIR/tun" "$OC_CORE_DIR/clash_tun"
          # chmod +x "$OC_CORE_DIR/clash_tun"
          
          echo "ðŸŽ‰ OpenClash é¢„ç½®æµç¨‹ç»“æŸ"
          
          # =======================================================

          # 6. å±•ç¤ºæœ€ç»ˆæ–‡ä»¶ç»“æž„ (è¿™æ˜¯ä½ åŽŸæœ‰çš„ä»£ç )
          echo "================================================"
          echo "ðŸ“‚ æœ€ç»ˆ files ç›®å½•ç»“æž„:"
          tree files/ || find files -type f -ls
          echo "================================================"
          echo "ðŸ“‚ æœ€ç»ˆ files/etc/99-custom.shæ–‡ä»¶å†…å®¹:"
          cat files/etc/uci-defaults/99-custom.sh
          echo "================================================"





          

      - name: Configure repositories
        run: |
          cd ${{ env.IMAGE_BUILDER_DIR }}
          
          echo "ðŸ”§ é…ç½®è½¯ä»¶æº..."
          # ä¿®å¤ KWRT ç‰¹æœ‰çš„æœ¬åœ°è·¯å¾„é—®é¢˜
          sed -i 's|file://www/wwwroot/|https://|g' repositories.conf
          sed -i 's|src |src/gz |g' repositories.conf
          
          # å¦‚æžœç”¨æˆ·ä»“åº“ä¸­æœ‰è‡ªå®šä¹‰ repositories.confï¼Œåˆ™è¦†ç›–
          if [ -f "${{ github.workspace }}/packages/repositories.conf" ]; then
            cp -f ${{ github.workspace }}/packages/repositories.conf repositories.conf
            echo "âœ… å·²ä½¿ç”¨è‡ªå®šä¹‰ repositories.conf"
          fi
          
          # æ·»åŠ  OpenWrt å®˜æ–¹æºè¡¥å…¨ç¼ºå¤±ä¾èµ–
          echo "" >> repositories.conf
          echo "# OpenWrt official repo for missing packages" >> repositories.conf
          echo "src/gz openwrt_packages https://downloads.openwrt.org/releases/${{ env.KWRT_PACKAGE_VERSION }}/packages/aarch64_cortex-a53/packages" >> repositories.conf
          echo "src/gz openwrt_luci https://downloads.openwrt.org/releases/${{ env.KWRT_PACKAGE_VERSION }}/packages/aarch64_cortex-a53/luci" >> repositories.conf
          
          echo "ðŸ“„ æœ€ç»ˆæºé…ç½®:"
          cat repositories.conf

      - name: Build firmware with Kwrt ImageBuilder
        run: |
          cd ${{ env.IMAGE_BUILDER_DIR }}
          
          echo "================================================"
          echo "å¼€å§‹æž„å»ºå›ºä»¶"
          echo "================================================"
          
          # åŸºç¡€åŒ… + åŠ¨æ€åŠŸèƒ½åŒ…
          PACKAGES="luci luci-ssl-openssl luci-base luci-compat"
          
          if [ "${{ github.event.inputs.include_docker }}" == "yes" ]; then
            PACKAGES="$PACKAGES docker dockerd luci-app-dockerman"
          fi
          
          if [ "${{ github.event.inputs.enable_store }}" == "true" ]; then
            PACKAGES="$PACKAGES luci-app-store"
          fi
          
          # è¯»å–è‡ªå®šä¹‰åŒ…åˆ—è¡¨
          if [ -f "${{ github.workspace }}/shell/custom-packages.sh" ]; then
            source ${{ github.workspace }}/shell/custom-packages.sh
            PACKAGES="$PACKAGES $CUSTOM_PACKAGES"
          fi
          
          echo "ðŸ“¦ è½¯ä»¶åŒ…åˆ—è¡¨: $PACKAGES"
          
          # ç¦ç”¨æœåŠ¡
          DISABLED_SERVICES="https-dns-proxy"
          
          # æž„å»ºå‘½ä»¤
          make image \
            PROFILE="${{ github.event.inputs.profile }}" \
            PACKAGES="$PACKAGES" \
            FILES="files" \
            DISABLED_SERVICES="$DISABLED_SERVICES" \
            -j$(nproc)

          echo "âœ… æž„å»ºå®Œæˆ"
          ls -lh bin/targets/${{ env.PLATFORM }}/

      - name: Verify build results
        run: |
          cd ${{ env.BUILD_TARGET_DIR }}
          echo "ðŸ“‹ ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨:"
          ls -lh

      - name: Create release info
        run: |
          cat > release-info.md << EOF
          ## ðŸŽ‰ ImmortalWrt Kwrt å›ºä»¶æž„å»ºä¿¡æ¯
          
          ### åŸºæœ¬ä¿¡æ¯
          - **è®¾å¤‡åž‹å·**: \`${{ github.event.inputs.profile }}\`
          - **ç®¡ç†åœ°å€**: \`${{ github.event.inputs.custom_router_ip }}\`
          - **Docker**: ${{ github.event.inputs.include_docker }}
          - **Store**: ${{ github.event.inputs.enable_store }}
          
          ### ä½¿ç”¨è¯´æ˜Ž
          HY3000å›ºä»¶h
          é»˜è®¤ç”¨æˆ·å: root, å¯†ç : root
          EOF

      # 1. æ–°å¢žè§£åŽ‹æ­¥éª¤
      - name: Extract firmware zip
        run: |
          cd ${{ env.BUILD_TARGET_DIR }}
          echo "ðŸ“‚ è§£åŽ‹å‰æ–‡ä»¶åˆ—è¡¨:"
          ls -lh
          
          echo "ðŸ”“ æ­£åœ¨è§£åŽ‹ ZIP æ–‡ä»¶..."
          # æŸ¥æ‰¾å¹¶è§£åŽ‹æ‰€æœ‰ zip æ–‡ä»¶ï¼Œ-o è¡¨ç¤ºè¦†ç›–ä¸è¯¢é—®
          for file in *.zip; do
            if [ -f "$file" ]; then
              echo "Unzipping $file..."
              unzip -o "$file"
            fi
          done
          
          echo "ðŸ—‘ï¸ åˆ é™¤åŽŸå§‹ zip æ–‡ä»¶ (å¯é€‰)..."
          rm -f *.zip
          
          echo "âœ… è§£åŽ‹åŽæ–‡ä»¶åˆ—è¡¨ (å‡†å¤‡ä¸Šä¼ ):"
          ls -lh *.bin || echo "âŒ æœªæ‰¾åˆ° bin æ–‡ä»¶"

      - name: Upload firmware to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.profile }}-${{ github.run_number }}
          name: "Kwrt-${{ github.event.inputs.profile }}-$(date +'%Y%m%d')"
          body_path: release-info.md
          files: |
            ${{ env.BUILD_TARGET_DIR }}/*.bin
            ${{ env.BUILD_TARGET_DIR }}/*.tar.zst
            ${{ env.BUILD_TARGET_DIR }}/sha256sums
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload firmware as artifact
        uses: actions/upload-artifact@v4
        with:
          name: Kwrt-${{ github.event.inputs.profile }}-${{ github.run_number }}
          path: ${{ env.BUILD_TARGET_DIR }}
          retention-days: 7
