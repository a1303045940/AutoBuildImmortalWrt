name: Build æ–°kwrt

on:
  workflow_dispatch:
    inputs:
      profile:
        type: choice
        description: "è¯·é€‰æ‹©mtkè·¯ç”±å™¨å‹å·"
        required: true
        options:
          - sl_3000-emmc
          - cmcc_rax3000m-nand
          
        default: sl_3000-emmc
      custom_router_ip:
        description: "è¯·è®¾ç½®è·¯ç”±å™¨çš„ç®¡ç†åœ°å€ æ ¼å¼:192.168.x.1 æˆ– 10.x.x.1"
        required: true
        default: "192.168.6.1"
      enable_store:
        description: "é›†æˆ store å•†åº—"
        required: false
        type: boolean
        default: true
      include_docker:
        description: "æ˜¯å¦ç¼–è¯‘ Docker æ’ä»¶"
        required: true
        default: 'no'
        type: choice
        options:
          - 'yes'
          - 'no'
      enable_pppoe:
        description: "æ˜¯å¦é…ç½®PPPoEæ‹¨å·ä¿¡æ¯?"
        required: true
        default: 'no'
        type: choice
        options:
          - 'yes'
          - 'no'
      pppoe_account:
        description: "å®½å¸¦è´¦å· (è‹¥å¯ç”¨PPPoE)"
        required: false
      pppoe_password:
        description: "å®½å¸¦å¯†ç  (è‹¥å¯ç”¨PPPoE)"
        required: false

env:
  KWRT_VERSION: "24.10"
  KWRT_PACKAGE_VERSION: "24.10.4"
  IMAGE_BUILDER_DIR: ""
  BUILD_TARGET_DIR: ""
  PLATFORM: ""

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget zstd

      - name: Set executable permissions
        run: |
          chmod +x ${{ github.workspace }}/mediatek-filogic/build24.sh || true
          chmod +x ${{ github.workspace }}/shell/*.sh || true

      - name: Save Custom Router IP
        run: |
          mkdir -p "${{ github.workspace }}/custom"
          echo "${{ github.event.inputs.custom_router_ip }}" > "${{ github.workspace }}/custom/custom_router_ip.txt"
          echo "âœ… è·¯ç”±å™¨ç®¡ç†åœ°å€: ${{ github.event.inputs.custom_router_ip }}"

      - name: Validate PPPoE Inputs
        run: |
          if [[ "${{ inputs.enable_pppoe }}" == "yes" ]]; then
            if [[ -z "${{ inputs.pppoe_account }}" || -z "${{ inputs.pppoe_password }}" ]]; then
              echo "âŒ Error: PPPoE account and password must be provided!"
              exit 1
            fi
            echo "âœ… PPPoE é…ç½®æœ‰æ•ˆ"
          fi

      - name: Enable Store integration
        run: |
          mkdir -p shell
          if [ "${{ github.event.inputs.enable_store }}" == "true" ]; then
            echo 'CUSTOM_PACKAGES="$CUSTOM_PACKAGES luci-app-store"' >> shell/custom-packages.sh
            echo "âœ… å·²è¿½åŠ  luci-app-store"
          else
            echo "â æœªå¯ç”¨ luci-app-store"
          fi

      - name: Determine platform and download URL
        id: setup
        run: |
          profile="${{ github.event.inputs.profile }}"
          echo "ğŸ”§ Building for profile: $profile"
          
          # é»˜è®¤å¹³å°
          platform="mediatek/filogic"
          download_url="https://dl.openwrt.ai/releases/${{ env.KWRT_VERSION }}/targets/mediatek/filogic/kwrt-imagebuilder-mediatek-filogic.Linux-x86_64.tar.zst"
          
          echo "platform=$platform" >> $GITHUB_ENV
          echo "PLATFORM=$platform" >> $GITHUB_ENV
          echo "download_url=$download_url" >> $GITHUB_ENV
          echo "ğŸ“¦ Platform: $platform"
          echo "ğŸ”— Download URL: $download_url"

      - name: Download and extract Kwrt ImageBuilder
        run: |
          echo "â¬‡ï¸  Downloading Kwrt ImageBuilder..."
          wget -q --show-progress ${{ env.download_url }}
          
          filename=$(basename ${{ env.download_url }})
          echo "ğŸ“¦ Extracting $filename..."
          tar --zstd -xf $filename
          
          # è·å–è§£å‹åçš„ç›®å½•å
          builder_dir=$(tar --zstd -tf $filename | head -1 | cut -f1 -d"/")
          echo "IMAGE_BUILDER_DIR=$builder_dir" >> $GITHUB_ENV
          echo "BUILD_TARGET_DIR=$builder_dir/bin/targets/${{ env.PLATFORM }}" >> $GITHUB_ENV
          echo "âœ… ImageBuilder å·²è§£å‹åˆ°: $builder_dir"

      - name: Prepare custom files
        run: |
          cd ${{ env.IMAGE_BUILDER_DIR }}
          
          # åˆ›å»ºè‡ªå®šä¹‰æ–‡ä»¶ç›®å½•
          mkdir -p files/etc/uci-defaults files/etc/config
          
          # å¤åˆ¶è‡ªå®šä¹‰é…ç½®
          if [ -d "${{ github.workspace }}/glinet" ]; then
            cp -r ${{ github.workspace }}/glinet/* files/etc/uci-defaults/ 2>/dev/null || true
            echo "âœ… å·²å¤åˆ¶ glinet é…ç½®"
          fi
          
          if [ -d "${{ github.workspace }}/custom" ]; then
            cp -r ${{ github.workspace }}/custom/* files/etc/config/ 2>/dev/null || true
            echo "âœ… å·²å¤åˆ¶ custom é…ç½®"
          fi
          
          # å¤åˆ¶æ¶æ„é…ç½®
          if [ -f "${{ github.workspace }}/arch/arch.conf" ]; then
            mkdir -p files/etc/opkg
            cp ${{ github.workspace }}/arch/arch.conf files/etc/opkg/arch.conf
            echo "âœ… å·²å¤åˆ¶ arch.conf"
          fi

      - name: Run build24.sh script
        run: |
          cd ${{ env.IMAGE_BUILDER_DIR }}
          
          # å¤åˆ¶ build24.sh åˆ° ImageBuilder ç›®å½•
          if [ -f "${{ github.workspace }}/mediatek-filogic/build24.sh" ]; then
            cp "${{ github.workspace }}/mediatek-filogic/build24.sh" ./build.sh
            chmod +x ./build.sh
            echo "âœ… å·²å¤åˆ¶ build24.sh"
          else
            echo "âš ï¸  æœªæ‰¾åˆ° build24.sh,ä½¿ç”¨é»˜è®¤æ„å»º"
          fi
          
          # è®¾ç½®ç¯å¢ƒå˜é‡ä¾›è„šæœ¬ä½¿ç”¨
          export PROFILE="${{ github.event.inputs.profile }}"
          export INCLUDE_DOCKER="${{ github.event.inputs.include_docker }}"
          export ENABLE_PPPOE="${{ inputs.enable_pppoe }}"
          export PPPOE_ACCOUNT="${{ inputs.pppoe_account }}"
          export PPPOE_PASSWORD="${{ inputs.pppoe_password }}"
          
          # å¦‚æœ build.sh å­˜åœ¨,æ‰§è¡Œå®ƒ
          if [ -f "./build.sh" ]; then
            echo "ğŸš€ æ‰§è¡Œ build24.sh è„šæœ¬..."
            bash ./build.sh
          else
            # é»˜è®¤æ„å»ºé€»è¾‘
            echo "ğŸš€ ä½¿ç”¨é»˜è®¤æ„å»ºæµç¨‹..."
            
            # åŸºç¡€è½¯ä»¶åŒ…
            PACKAGES="luci luci-ssl-openssl luci-compat"
            PACKAGES="$PACKAGES base-files busybox dnsmasq-full firewall4"
            PACKAGES="$PACKAGES autocore bash htop nano wget-ssl curl"
            PACKAGES="$PACKAGES automount block-mount kmod-usb-storage"
            PACKAGES="$PACKAGES kmod-fs-ext4 kmod-fs-exfat kmod-fs-vfat"
            
            # Docker æ”¯æŒ
            if [ "$INCLUDE_DOCKER" == "yes" ]; then
              PACKAGES="$PACKAGES docker dockerd luci-app-dockerman"
              echo "âœ… å·²æ·»åŠ  Docker æ”¯æŒ"
            fi
            
            # Store å•†åº—
            if [ "${{ github.event.inputs.enable_store }}" == "true" ]; then
              PACKAGES="$PACKAGES luci-app-store"
              echo "âœ… å·²æ·»åŠ  Store å•†åº—"
            fi
            
            # è‡ªå®šä¹‰åŒ…
            if [ -f "${{ github.workspace }}/shell/custom-packages.sh" ]; then
              source ${{ github.workspace }}/shell/custom-packages.sh
              PACKAGES="$PACKAGES $CUSTOM_PACKAGES"
            fi
            
            echo "ğŸ“¦ è½¯ä»¶åŒ…åˆ—è¡¨: $PACKAGES"
            
            # æ„å»ºå›ºä»¶
            make image \
              PROFILE="$PROFILE" \
              PACKAGES="$PACKAGES" \
              FILES="files" \
              DISABLED_SERVICES="https-dns-proxy"
          fi
          
          echo "âœ… å›ºä»¶æ„å»ºå®Œæˆ!"
          ls -lh bin/targets/${{ env.PLATFORM }}/

      - name: Verify firmware output
        run: |
          echo "ğŸ” éªŒè¯æ„å»ºäº§ç‰©..."
          
          BUILD_DIR="${{ env.BUILD_TARGET_DIR }}"
          
          if [ ! -d "$BUILD_DIR" ]; then
            echo "âŒ æ„å»ºç›®å½•ä¸å­˜åœ¨: $BUILD_DIR"
            exit 1
          fi
          
          echo "ğŸ“Š å›ºä»¶æ–‡ä»¶åˆ—è¡¨:"
          ls -lh "$BUILD_DIR"
          
          # æ£€æŸ¥ sysupgrade æ–‡ä»¶
          SYSUPGRADE=$(find "$BUILD_DIR" -name "*-sysupgrade.bin" | head -1)
          if [ -n "$SYSUPGRADE" ]; then
            FILE_SIZE=$(stat -c%s "$SYSUPGRADE")
            FILE_SIZE_MB=$((FILE_SIZE / 1024 / 1024))
            echo "âœ… Sysupgrade å›ºä»¶: $(basename $SYSUPGRADE) (${FILE_SIZE_MB}MB)"
            
            if [ $FILE_SIZE_MB -lt 10 ]; then
              echo "âš ï¸  è­¦å‘Š: å›ºä»¶å¤§å°å¼‚å¸¸å° (${FILE_SIZE_MB}MB)"
            fi
          else
            echo "âš ï¸  æœªæ‰¾åˆ° sysupgrade å›ºä»¶"
          fi
          
          # æ˜¾ç¤º manifest
          MANIFEST=$(find "$BUILD_DIR" -name "*.manifest" | head -1)
          if [ -n "$MANIFEST" ]; then
            PKG_COUNT=$(wc -l < "$MANIFEST")
            echo "ğŸ“¦ å·²å®‰è£…è½¯ä»¶åŒ…æ•°é‡: $PKG_COUNT"
          fi

      - name: Configure PPPoE (if enabled)
        if: ${{ inputs.enable_pppoe == 'yes' }}
        run: |
          echo "ğŸ”§ åå¤„ç† PPPoE é…ç½®..."
          echo "è´¦å·: ${{ inputs.pppoe_account }}"

      - name: Create release info
        run: |
          INFO_FILE="${{ github.workspace }}/mediatek-filogic/info.md"
          
          mkdir -p $(dirname "$INFO_FILE")
          cat > "$INFO_FILE" << EOF
          ## ğŸ‰ Kwrt å›ºä»¶æ„å»ºä¿¡æ¯
          
          ### åŸºæœ¬ä¿¡æ¯
          - **æ„å»ºå¹³å°**: \`${{ env.PLATFORM }}\`
          - **è®¾å¤‡å‹å·**: \`${{ github.event.inputs.profile }}\`
          - **Kwrt ç‰ˆæœ¬**: \`${{ env.KWRT_VERSION }}\`
          - **ç®¡ç†åœ°å€**: \`${{ github.event.inputs.custom_router_ip }}\`
          - **æ„å»ºæ—¶é—´**: \`$(date '+%Y-%m-%d %H:%M:%S')\`
          
          ### åŠŸèƒ½ç‰¹æ€§
          - **Docker æ”¯æŒ**: ${{ github.event.inputs.include_docker == 'yes' && 'âœ… å·²å¯ç”¨' || 'âŒ æœªå¯ç”¨' }}
          - **Store å•†åº—**: ${{ github.event.inputs.enable_store == 'true' && 'âœ… å·²å¯ç”¨' || 'âŒ æœªå¯ç”¨' }}
          - **PPPoE æ‹¨å·**: ${{ inputs.enable_pppoe == 'yes' && 'âœ… å·²é…ç½®' || 'âŒ æœªé…ç½®' }}
          
          ### ä¸‹è½½è¯´æ˜
          - \`*-squashfs-sysupgrade.bin\`: ç³»ç»Ÿå‡çº§å›ºä»¶ (å·²æœ‰ OpenWrt ç³»ç»Ÿä½¿ç”¨)
          - \`*-factory.bin\`: åˆæ¬¡åˆ·æœºå›ºä»¶ (ä»åŸå‚å›ºä»¶åˆ·å…¥)
          - \`sha256sums\`: æ–‡ä»¶æ ¡éªŒå’Œ
          
          ### é»˜è®¤ä¿¡æ¯
          - ç®¡ç†åœ°å€: http://${{ github.event.inputs.custom_router_ip }}
          - é»˜è®¤ç”¨æˆ·å: root
          - é»˜è®¤å¯†ç : password
          EOF
          
          echo "ğŸ“„ Release ä¿¡æ¯å·²ç”Ÿæˆ"

      - name: Upload firmware to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.profile }}-${{ github.run_number }}
          name: "Kwrt-${{ github.event.inputs.profile }}"
          body_path: ${{ github.workspace }}/mediatek-filogic/info.md
          files: |
            ${{ env.BUILD_TARGET_DIR }}/*
          token: ${{ secrets.GITHUB_TOKEN }}
          makeLatest: true
          allowUpdates: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload firmware as artifact
        uses: actions/upload-artifact@v4
        with:
          name: Kwrt-${{ github.event.inputs.profile }}
          path: ${{ env.BUILD_TARGET_DIR }}
          retention-days: 7
