name: Build æ–°KWRT

on:
  workflow_dispatch:
    inputs:
      profile:
        type: choice
        description: "è¯·é€‰æ‹©mtkè·¯ç”±å™¨åž‹å·"
        required: true
        options:
          - cmcc_rax3000m-nand
          - sl_3000-emmc
        default: sl_3000-emmc
      custom_router_ip:
        description: "è¯·è®¾ç½®è·¯ç”±å™¨çš„ç®¡ç†åœ°å€ æ ¼å¼:192.168.x.1 æˆ– 10.x.x.1"
        required: true
        default: "192.168.6.1"
      enable_store:
        description: "é›†æˆ store å•†åº—"
        required: false
        type: boolean
        default: true
      include_docker:
        description: "æ˜¯å¦ç¼–è¯‘ Docker æ’ä»¶"
        required: true
        default: 'no'
        type: choice
        options:
          - 'yes'
          - 'no'
      enable_pppoe:
        description: "æ˜¯å¦é…ç½®PPPoEæ‹¨å·ä¿¡æ¯?"
        required: true
        default: 'no'
        type: choice
        options:
          - 'yes'
          - 'no'
      pppoe_account:
        description: "å®½å¸¦è´¦å· (è‹¥å¯ç”¨PPPoE)"
        required: false
      pppoe_password:
        description: "å®½å¸¦å¯†ç  (è‹¥å¯ç”¨PPPoE)"
        required: false

env:
  KWRT_VERSION: "24.10"
  KWRT_PACKAGE_VERSION: "24.10.4"
  IMAGE_BUILDER_DIR: ""
  BUILD_TARGET_DIR: ""
  PLATFORM: ""

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget zstd tree

      - name: Save Custom Router IP
        run: |
          mkdir -p "${{ github.workspace }}/custom"
          echo "${{ github.event.inputs.custom_router_ip }}" > "${{ github.workspace }}/custom/custom_router_ip.txt"
          echo "âœ… è·¯ç”±å™¨ç®¡ç†åœ°å€: ${{ github.event.inputs.custom_router_ip }}"

      - name: Validate PPPoE Inputs
        run: |
          if [[ "${{ inputs.enable_pppoe }}" == "yes" ]]; then
            if [[ -z "${{ inputs.pppoe_account }}" || -z "${{ inputs.pppoe_password }}" ]]; then
              echo "âŒ Error: PPPoE account and password must be provided!"
              exit 1
            fi
          fi

      - name: Enable Store integration
        run: |
          if [ "${{ github.event.inputs.enable_store }}" == "true" ]; then
            mkdir -p shell
            echo 'CUSTOM_PACKAGES="$CUSTOM_PACKAGES luci-app-store"' >> shell/custom-packages.sh
            echo "âœ… å·²è¿½åŠ  luci-app-store"
          else
            echo "âŽ æœªå¯ç”¨ luci-app-store"
          fi

      - name: Determine platform and download URL
        id: setup
        run: |
          profile="${{ github.event.inputs.profile }}"
          echo "ðŸ”§ Building for profile: $profile"
          
          # é»˜è®¤å¹³å°
          platform="mediatek/filogic"
          download_url="https://github.com/a1303045940/Kwrt/releases/download/12%2F02_2025_15%2F20_mediatek_filogic/openwrt-imagebuilder-mediatek-filogic.Linux-x86_64.tar.zst"
          
          # è¯»å– ipq807x æœºåž‹
          if [ -f model/ipq807x.txt ]; then
            ipq807x_models=$(cat model/ipq807x.txt | tr '\n' '|')
            ipq807x_models=${ipq807x_models%|}
            if [[ "$profile" =~ ^($ipq807x_models)$ ]]; then
              platform="qualcommax/ipq807x"
              download_url="https://dl.openwrt.ai/releases/${{ env.KWRT_VERSION }}/targets/qualcommax/ipq807x/kwrt-imagebuilder-qualcommax-ipq807x.Linux-x86_64.tar.zst"
            fi
          fi
          
          # è¯»å– mt7621 æœºåž‹
          if [ -f model/mt7621.txt ]; then
            mt7621_models=$(cat model/mt7621.txt | tr '\n' '|')
            mt7621_models=${mt7621_models%|}
            if [[ "$profile" =~ ^($mt7621_models)$ ]]; then
              platform="ramips/mt7621"
              download_url="https://dl.openwrt.ai/releases/${{ env.KWRT_VERSION }}/targets/ramips/mt7621/kwrt-imagebuilder-ramips-mt7621.Linux-x86_64.tar.zst"
            fi
          fi
          
          # è¯»å– bcm53xx æœºåž‹
          if [ -f model/bcm53xx.txt ]; then
            bcm53xx_models=$(cat model/bcm53xx.txt | tr '\n' '|')
            bcm53xx_models=${bcm53xx_models%|}
            if [[ "$profile" =~ ^($bcm53xx_models)$ ]]; then
              platform="bcm53xx/generic"
              download_url="https://github.com/a1303045940/Kwrt/releases/download/12%2F02_2025_15%2F20_mediatek_filogic/openwrt-imagebuilder-mediatek-filogic.Linux-x86_64.tar.zst"
            fi
          fi
          
          # ç‰¹æ®Šæœºåž‹å¤„ç†
          case "$profile" in
            glinet_gl-b2200)
              platform="ipq40xx/generic"
              download_url="https://dl.openwrt.ai/releases/${{ env.KWRT_VERSION }}/targets/ipq40xx/generic/kwrt-imagebuilder-ipq40xx-generic.Linux-x86_64.tar.zst"
              ;;
            glinet_gl-axt1800|glinet_gl-ax1800)
              platform="qualcommax/ipq60xx"
              download_url="https://dl.openwrt.ai/releases/${{ env.KWRT_VERSION }}/targets/qualcommax/ipq60xx/kwrt-imagebuilder-qualcommax-ipq60xx.Linux-x86_64.tar.zst"
              ;;
          esac
          
          echo "platform=$platform" >> $GITHUB_ENV
          echo "PLATFORM=$platform" >> $GITHUB_ENV
          echo "download_url=$download_url" >> $GITHUB_ENV
          echo "ðŸ“¦ Platform: $platform"
          echo "ðŸ”— Download URL: $download_url"

      - name: Download and extract Kwrt ImageBuilder
        run: |
          echo "â¬‡ï¸ Downloading ImageBuilder..."
          wget -q --show-progress ${{ env.download_url }}
          
          filename=$(basename ${{ env.download_url }})
          echo "ðŸ“¦ Extracting $filename..."
          
          if [[ "$filename" =~ \.tar\.gz$ ]]; then
            tar -xzf "$filename"
          elif [[ "$filename" =~ \.tar\.zst$ ]]; then
            tar --zstd -xf "$filename"
          else
            echo "âŒ ä¸æ”¯æŒçš„æ ¼å¼"
            exit 1
          fi
          
          # èŽ·å–è§£åŽ‹åŽçš„ç›®å½•å
          builder_dir=$(tar --zstd -tf $filename | head -1 | cut -f1 -d"/")
          echo "IMAGE_BUILDER_DIR=$builder_dir" >> $GITHUB_ENV
          echo "BUILD_TARGET_DIR=$builder_dir/bin/targets/${{ env.PLATFORM }}" >> $GITHUB_ENV
          echo "âœ… ImageBuilder å·²è§£åŽ‹åˆ°: $builder_dir"

      - name: Prepare custom files
        run: |
          cd ${{ env.IMAGE_BUILDER_DIR }}
          
          echo "================================================"
          echo "å‡†å¤‡è‡ªå®šä¹‰æ–‡ä»¶"
          echo "================================================"
          
          # åˆ›å»ºç›®å½•
          mkdir -p files/etc/uci-defaults files/etc/config
          
          # 1. å¤åˆ¶ 99-custom.sh
          if [ -f "${{ github.workspace }}/files/etc/uci-defaults/99-custom.sh" ]; then
            cp ${{ github.workspace }}/files/etc/uci-defaults/99-custom.sh files/etc/uci-defaults/
            chmod +x files/etc/uci-defaults/99-custom.sh
            echo "âœ… å·²å¤åˆ¶ 99-custom.sh"
          fi
          
          # 2. åˆ›å»º PPPoE é…ç½®
          cat > files/etc/config/pppoe-settings << 'EOF'
          enable_pppoe=${{ github.event.inputs.enable_pppoe }}
          pppoe_account=${{ github.event.inputs.pppoe_account }}
          pppoe_password=${{ github.event.inputs.pppoe_password }}
          EOF
          echo "âœ… å·²åˆ›å»º pppoe-settings"
          
          # 3. å¤åˆ¶è·¯ç”±å™¨ IP
          if [ -f "${{ github.workspace }}/custom/custom_router_ip.txt" ]; then
            cp ${{ github.workspace }}/custom/custom_router_ip.txt files/etc/config/
            echo "âœ… å·²å¤åˆ¶è·¯ç”±å™¨ IP é…ç½®"
          fi
          
          # 4. å¤åˆ¶å…¶ä»–é…ç½®
          if [ -d "${{ github.workspace }}/glinet" ]; then
            cp -r ${{ github.workspace }}/glinet/* files/etc/uci-defaults/ 2>/dev/null || true
          fi
          
          if [ -f "${{ github.workspace }}/arch/arch.conf" ]; then
            mkdir -p files/etc/opkg
            cp ${{ github.workspace }}/arch/arch.conf files/etc/opkg/arch.conf
          fi
          
          # æ˜¾ç¤ºæ–‡ä»¶ç»“æž„
          echo "ðŸ“‚ files ç›®å½•ç»“æž„:"
          tree files/ || find files -type f
          
      # - name: Configure repositories
      #   run: |
      #     cd ${{ env.IMAGE_BUILDER_DIR }}
          
      #     echo "ðŸ”§ é…ç½®è½¯ä»¶æº..."
      #     cp repositories.conf repositories.conf.bak
          
      #     # ä¿®æ”¹ä¸ºåœ¨çº¿æº
      #     sed -i 's|file://www/wwwroot/|https://|g' repositories.conf
      #     sed -i 's|src |src/gz |g' repositories.conf
          
      #     # ç§»é™¤å¤±æ•ˆæº
      #     #sed -i '/kiddin9/d' repositories.conf
          
      #     echo "================================================"
      #     echo "ðŸ“„ repositories.conf:"
      #     echo "================================================"
      #     cat repositories.conf
      #     echo "================================================"
          
      - name: Build firmware with Kwrt ImageBuilder
        run: |
          cd ${{ env.IMAGE_BUILDER_DIR }}
          
          echo "================================================"
          echo "å¼€å§‹æž„å»ºå›ºä»¶"
          echo "================================================"
          
          # åŸºç¡€è½¯ä»¶åŒ…
          PACKAGES="luci luci-ssl-openssl luci-i18n-base-zh-cn luci-i18n-firewall-zh-cn"
          
          # Docker
          if [ "${{ github.event.inputs.include_docker }}" == "yes" ]; then
            PACKAGES="$PACKAGES luci-app-dockerman luci-i18n-dockerman-zh-cn docker dockerd"
            echo "âœ… å·²æ·»åŠ  Docker"
          fi
          
          # Store
          if [ "${{ github.event.inputs.enable_store }}" == "true" ]; then
            PACKAGES="$PACKAGES luci-app-store"
            echo "âœ… å·²æ·»åŠ  Store"
          fi
          
          # è‡ªå®šä¹‰åŒ…
          if [ -f "${{ github.workspace }}/shell/custom-packages.sh" ]; then
            source ${{ github.workspace }}/shell/custom-packages.sh
            PACKAGES="$PACKAGES $CUSTOM_PACKAGES"
            echo "âœ… å·²æ·»åŠ è‡ªå®šä¹‰åŒ…"
          fi
          
          echo "================================================"
          echo "ðŸ“¦ è½¯ä»¶åŒ…åˆ—è¡¨:"
          echo "$PACKAGES" | tr ' ' '\n'
          echo "================================================"
          
          # æž„å»º
          echo "ðŸš€ æ‰§è¡Œæž„å»º..."
          make image \
            PROFILE="${{ github.event.inputs.profile }}" \
            PACKAGES="$PACKAGES" \
            FILES="files" \
            DISABLED_SERVICES="https-dns-proxy" 2>&1 | tee build.log
          
          # æ£€æŸ¥é”™è¯¯
          if grep -q "satisfy_dependencies" build.log; then
            echo "âš ï¸ ä¾èµ–é—®é¢˜:"
            grep "satisfy_dependencies" build.log
          fi
          
          echo "================================================"
          echo "âœ… æž„å»ºå®Œæˆ"
          echo "================================================"
          ls -lh bin/targets/${{ env.PLATFORM }}/

      - name: Verify build results
        run: |
          cd ${{ env.BUILD_TARGET_DIR }}
          
          echo "ðŸ“‹ ç”Ÿæˆçš„æ–‡ä»¶:"
          ls -lh
          
          echo ""
          echo "ðŸ“¦ å›ºä»¶å¤§å°:"
          du -h *.bin 2>/dev/null || echo "æœªæ‰¾åˆ° .bin æ–‡ä»¶"

      - name: Create release info
        run: |
          cat > release-info.md << EOF
          ## ðŸŽ‰ ImmortalWrt Kwrt å›ºä»¶æž„å»ºä¿¡æ¯
          
          ### åŸºæœ¬ä¿¡æ¯
          - **æž„å»ºå¹³å°**: \`${{ env.PLATFORM }}\`
          - **è®¾å¤‡åž‹å·**: \`${{ github.event.inputs.profile }}\`
          - **Kwrt ç‰ˆæœ¬**: \`${{ env.KWRT_VERSION }}\`
          - **ç®¡ç†åœ°å€**: \`${{ github.event.inputs.custom_router_ip }}\`
          - **æž„å»ºæ—¶é—´**: \`$(date '+%Y-%m-%d %H:%M:%S')\`
          
          ### åŠŸèƒ½ç‰¹æ€§
          - **Docker æ”¯æŒ**: ${{ github.event.inputs.include_docker == 'yes' && 'âœ… å·²å¯ç”¨' || 'âŒ æœªå¯ç”¨' }}
          - **Store å•†åº—**: ${{ github.event.inputs.enable_store == 'true' && 'âœ… å·²å¯ç”¨' || 'âŒ æœªå¯ç”¨' }}
          - **PPPoE æ‹¨å·**: ${{ inputs.enable_pppoe == 'yes' && 'âœ… å·²é…ç½®' || 'âŒ æœªé…ç½®' }}
          - **uci-defaults**: âœ… å·²é›†æˆ (é¦–æ¬¡å¯åŠ¨è‡ªåŠ¨æ‰§è¡Œ)
          
          ### ä¸‹è½½è¯´æ˜Ž
          - \`*-squashfs-sysupgrade.bin\`: ç³»ç»Ÿå‡çº§å›ºä»¶
          - \`*-factory.bin\`: åˆæ¬¡åˆ·æœºå›ºä»¶
          - \`sha256sums\`: æ–‡ä»¶æ ¡éªŒå’Œ
          
          ### é»˜è®¤ä¿¡æ¯
          - ç®¡ç†åœ°å€: http://${{ github.event.inputs.custom_router_ip }}
          - é»˜è®¤ç”¨æˆ·å: root
          - é»˜è®¤å¯†ç : password
          EOF
          
          cat release-info.md

      - name: Upload firmware to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.profile }}-${{ github.run_number }}
          name: "Kwrt-${{ github.event.inputs.profile }}-$(date +'%Y%m%d')"
          body_path: release-info.md
          files: |
            ${{ env.BUILD_TARGET_DIR }}/*.bin
            ${{ env.BUILD_TARGET_DIR }}/sha256sums
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload firmware as artifact
        uses: actions/upload-artifact@v4
        with:
          name: Kwrt-${{ github.event.inputs.profile }}-${{ github.run_number }}
          path: ${{ env.BUILD_TARGET_DIR }}
          retention-days: 7
