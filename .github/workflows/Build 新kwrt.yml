name: Build æ–°KWRT

on:
  workflow_dispatch:
    inputs:
      profile:
        type: choice
        description: "è¯·é€‰æ‹©mtkè·¯ç”±å™¨åž‹å·"
        required: true
        options:
          - cmcc_rax3000m-nand
          - sl_3000-emmc
        default: sl_3000-emmc
      custom_router_ip:
        description: "è¯·è®¾ç½®è·¯ç”±å™¨çš„ç®¡ç†åœ°å€ æ ¼å¼:192.168.x.1 æˆ– 10.x.x.1"
        required: true
        default: "192.168.6.1"
      enable_store:
        description: "é›†æˆ store å•†åº—"
        required: false
        type: boolean
        default: true
      include_docker:
        description: "æ˜¯å¦ç¼–è¯‘ Docker æ’ä»¶"
        required: true
        default: 'no'
        type: choice
        options:
          - 'yes'
          - 'no'
      enable_pppoe:
        description: "æ˜¯å¦é…ç½®PPPoEæ‹¨å·ä¿¡æ¯?"
        required: true
        default: 'no'
        type: choice
        options:
          - 'yes'
          - 'no'
      pppoe_account:
        description: "å®½å¸¦è´¦å· (è‹¥å¯ç”¨PPPoE)"
        required: false
      pppoe_password:
        description: "å®½å¸¦å¯†ç  (è‹¥å¯ç”¨PPPoE)"
        required: false

env:
  KWRT_VERSION: "24.10"
  KWRT_PACKAGE_VERSION: "24.10.4"
  IMAGE_BUILDER_DIR: ""
  BUILD_TARGET_DIR: ""
  PLATFORM: ""

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget zstd

      - name: Save Custom Router IP
        run: |
          mkdir -p "${{ github.workspace }}/custom"
          echo "${{ github.event.inputs.custom_router_ip }}" > "${{ github.workspace }}/custom/custom_router_ip.txt"
          echo "âœ… è·¯ç”±å™¨ç®¡ç†åœ°å€: ${{ github.event.inputs.custom_router_ip }}"

      - name: Validate PPPoE Inputs
        run: |
          if [[ "${{ inputs.enable_pppoe }}" == "yes" ]]; then
            if [[ -z "${{ inputs.pppoe_account }}" || -z "${{ inputs.pppoe_password }}" ]]; then
              echo "âŒ Error: PPPoE account and password must be provided!"
              exit 1
            fi
          fi

      - name: Enable Store integration
        run: |
          if [ "${{ github.event.inputs.enable_store }}" == "true" ]; then
            mkdir -p shell
            echo 'CUSTOM_PACKAGES="$CUSTOM_PACKAGES luci-app-store"' >> shell/custom-packages.sh
            echo "âœ… å·²è¿½åŠ  luci-app-store"
          else
            echo "âŽ æœªå¯ç”¨ luci-app-store"
          fi

      - name: Determine platform and download URL
        id: setup
        run: |
          profile="${{ github.event.inputs.profile }}"
          echo "ðŸ”§ Building for profile: $profile"
          
          # é»˜è®¤å¹³å°
          platform="mediatek/filogic"
          download_url="https://dl.openwrt.ai/releases/${{ env.KWRT_VERSION }}/targets/mediatek/filogic/kwrt-imagebuilder-mediatek-filogic.Linux-x86_64.tar.zst"
          
          
          echo "platform=$platform" >> $GITHUB_ENV
          echo "PLATFORM=$platform" >> $GITHUB_ENV
          echo "download_url=$download_url" >> $GITHUB_ENV
          echo "ðŸ“¦ Platform: $platform"
          echo "ðŸ”— Download URL: $download_url"

      - name: Download and extract Kwrt ImageBuilder
        run: |
          echo "â¬‡ï¸ Downloading ImageBuilder..."
          wget -q --show-progress ${{ env.download_url }}
          
          filename=$(basename ${{ env.download_url }})
          echo "ðŸ“¦ Extracting $filename..."
          tar --zstd -xf $filename
          
          # èŽ·å–è§£åŽ‹åŽçš„ç›®å½•å
          builder_dir=$(tar --zstd -tf $filename | head -1 | cut -f1 -d"/")
          echo "IMAGE_BUILDER_DIR=$builder_dir" >> $GITHUB_ENV
          echo "BUILD_TARGET_DIR=$builder_dir/bin/targets/${{ env.PLATFORM }}" >> $GITHUB_ENV
          echo "âœ… ImageBuilder å·²è§£åŽ‹åˆ°: $builder_dir"

      - name: Prepare custom files
        run: |
          cd ${{ env.IMAGE_BUILDER_DIR }}
          
          # åˆ›å»ºè‡ªå®šä¹‰æ–‡ä»¶ç›®å½•
          mkdir -p files/etc/uci-defaults files/etc/config
          
          # å¤åˆ¶è‡ªå®šä¹‰é…ç½®
          if [ -d "${{ github.workspace }}/glinet" ]; then
            cp -r ${{ github.workspace }}/glinet/* files/etc/uci-defaults/ 2>/dev/null || true
            echo "âœ… å·²å¤åˆ¶ glinet é…ç½®"
          fi
          
          if [ -d "${{ github.workspace }}/custom" ]; then
            cp -r ${{ github.workspace }}/custom/* files/etc/config/ 2>/dev/null || true
            echo "âœ… å·²å¤åˆ¶ custom é…ç½®"
          fi
          
          # å¤åˆ¶æž¶æž„é…ç½®
          if [ -f "${{ github.workspace }}/arch/arch.conf" ]; then
            mkdir -p files/etc/opkg
            cp ${{ github.workspace }}/arch/arch.conf files/etc/opkg/arch.conf
            echo "âœ… å·²å¤åˆ¶ arch.conf"
          fi

      - name: Configure repositories
        run: |
          cd ${{ env.IMAGE_BUILDER_DIR }}
          
          echo "ðŸ”§ é…ç½®è½¯ä»¶æº..."
          # ä¿®æ”¹ Kwrt è½¯ä»¶æºä¸ºåœ¨çº¿åœ°å€
          sed -i 's|file://www/wwwroot/|https://|g' repositories.conf
          sed -i 's|src |src/gz |g' repositories.conf
          
          # æ·»åŠ  OpenWrt å®˜æ–¹æºä½œä¸ºè¡¥å……
          echo "" >> repositories.conf
          echo "# OpenWrt official repo for missing packages" >> repositories.conf
          echo "src/gz openwrt_packages https://downloads.openwrt.org/releases/${{ env.KWRT_PACKAGE_VERSION }}/packages/aarch64_cortex-a53/packages" >> repositories.conf
          echo "src/gz openwrt_luci https://downloads.openwrt.org/releases/${{ env.KWRT_PACKAGE_VERSION }}/packages/aarch64_cortex-a53/luci" >> repositories.conf
          
          echo "ðŸ“„ repositories.conf å†…å®¹:"
          cat repositories.conf

      - name: Build firmware with Kwrt ImageBuilder
        run: |
          cd ${{ env.IMAGE_BUILDER_DIR }}
          
          # åŸºç¡€è½¯ä»¶åŒ…åˆ—è¡¨
          PACKAGES="luci luci-ssl-openssl luci-base luci-compat"
          
          # Docker æ”¯æŒ
          if [ "${{ github.event.inputs.include_docker }}" == "yes" ]; then
            PACKAGES="$PACKAGES docker dockerd luci-app-dockerman"
            echo "âœ… å·²æ·»åŠ  Docker æ”¯æŒ"
          fi
          
          # Store å•†åº—
          if [ "${{ github.event.inputs.enable_store }}" == "true" ]; then
            PACKAGES="$PACKAGES luci-app-store"
            echo "âœ… å·²æ·»åŠ  Store å•†åº—"
          fi
          
          # å¦‚æžœæœ‰è‡ªå®šä¹‰åŒ…é…ç½®
          if [ -f "${{ github.workspace }}/shell/custom-packages.sh" ]; then
            source ${{ github.workspace }}/shell/custom-packages.sh
            PACKAGES="$PACKAGES $CUSTOM_PACKAGES"
          fi
          
          echo "ðŸ“¦ è½¯ä»¶åŒ…åˆ—è¡¨: $PACKAGES"
          
          # ç¦ç”¨çš„æœåŠ¡
          DISABLED_SERVICES="https-dns-proxy"
          
          echo "ðŸš€ å¼€å§‹æž„å»ºå›ºä»¶..."
          make image \
            PROFILE="${{ github.event.inputs.profile }}" \
            PACKAGES="$PACKAGES" \
            FILES="files" \
            DISABLED_SERVICES="$DISABLED_SERVICES"
          
          echo "âœ… å›ºä»¶æž„å»ºå®Œæˆ!"
          ls -lh bin/targets/${{ env.PLATFORM }}/

      - name: Configure PPPoE (if enabled)
        if: ${{ inputs.enable_pppoe == 'yes' }}
        run: |
          cd ${{ env.IMAGE_BUILDER_DIR }}
          
          echo "ðŸ”§ é…ç½® PPPoE æ‹¨å·..."
          mkdir -p files/etc/config
          cat > files/etc/config/pppoe-config << EOF
          # PPPoE Configuration
          ACCOUNT=${{ inputs.pppoe_account }}
          PASSWORD=${{ inputs.pppoe_password }}
          EOF
          echo "âœ… PPPoE é…ç½®å·²ä¿å­˜"

      - name: Create release info
        run: |
          cat > release-info.md << EOF
          ## ðŸŽ‰ ImmortalWrt Kwrt å›ºä»¶æž„å»ºä¿¡æ¯
          
          ### åŸºæœ¬ä¿¡æ¯
          - **æž„å»ºå¹³å°**: \`${{ env.PLATFORM }}\`
          - **è®¾å¤‡åž‹å·**: \`${{ github.event.inputs.profile }}\`
          - **Kwrt ç‰ˆæœ¬**: \`${{ env.KWRT_VERSION }}\`
          - **ç®¡ç†åœ°å€**: \`${{ github.event.inputs.custom_router_ip }}\`
          - **æž„å»ºæ—¶é—´**: \`$(date '+%Y-%m-%d %H:%M:%S')\`
          
          ### åŠŸèƒ½ç‰¹æ€§
          - **Docker æ”¯æŒ**: ${{ github.event.inputs.include_docker == 'yes' && 'âœ… å·²å¯ç”¨' || 'âŒ æœªå¯ç”¨' }}
          - **Store å•†åº—**: ${{ github.event.inputs.enable_store == 'true' && 'âœ… å·²å¯ç”¨' || 'âŒ æœªå¯ç”¨' }}
          - **PPPoE æ‹¨å·**: ${{ inputs.enable_pppoe == 'yes' && 'âœ… å·²é…ç½®' || 'âŒ æœªé…ç½®' }}
          
          ### ä¸‹è½½è¯´æ˜Ž
          - \`*-squashfs-sysupgrade.bin\`: ç³»ç»Ÿå‡çº§å›ºä»¶ (å·²æœ‰ OpenWrt ç³»ç»Ÿä½¿ç”¨)
          - \`*-factory.bin\`: åˆæ¬¡åˆ·æœºå›ºä»¶ (ä»ŽåŽŸåŽ‚å›ºä»¶åˆ·å…¥)
          - \`sha256sums\`: æ–‡ä»¶æ ¡éªŒå’Œ
          
          ### é»˜è®¤ä¿¡æ¯
          - ç®¡ç†åœ°å€: http://${{ github.event.inputs.custom_router_ip }}
          - é»˜è®¤ç”¨æˆ·å: root
          - é»˜è®¤å¯†ç : password (é¦–æ¬¡ç™»å½•éœ€ä¿®æ”¹)
          EOF
          
          cat release-info.md

      - name: Upload firmware to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.profile }}-${{ github.run_number }}
          name: "Kwrt-${{ github.event.inputs.profile }}"
          body_path: release-info.md
          files: |
            ${{ env.BUILD_TARGET_DIR }}/*
          token: ${{ secrets.GITHUB_TOKEN }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload firmware as artifact
        uses: actions/upload-artifact@v4
        with:
          name: Kwrt-${{ github.event.inputs.profile }}
          path: ${{ env.BUILD_TARGET_DIR }}
          retention-days: 7
