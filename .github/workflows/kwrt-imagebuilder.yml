name: kwrt-imagebuilder

on:
  workflow_dispatch:
    inputs:
      profile:
        type: choice
        description: "è¯·é€‰æ‹©mtkè·¯ç”±å™¨åž‹å·"
        required: true
        options:
          # ä½ çš„å®Œæ•´åž‹å·åˆ—è¡¨ï¼ˆè¿™é‡Œåªå±•ç¤ºéƒ¨åˆ†ï¼Œå®Œæ•´å¤åˆ¶ä½ çš„åˆ—è¡¨ï¼‰
          - glinet_gl-mt2500
          - glinet_gl-mt3000
          - glinet_gl-mt6000
          - glinet_gl-axt1800
          - glinet_gl-ax1800
          - glinet_gl-b2200
          - glinet_gl-x3000
          - glinet_gl-xe3000
          - huasifei_wh3000-emmc
          - cudy_tr3000-v1
          - cudy_tr3000-v1-ubootmod
          - cudy_tr3000-256mb-v1
          - jcg_q30-pro
          - jcg_q30
          - jcg_q30-ubootmod
          - jdcloud_re-cp-03
          - xiaomi_mi-router-ax3000t
          - xiaomi_mi-router-ax3000t-ubootmod
          - xiaomi_mi-router-wr30u-stock
          - xiaomi_mi-router-wr30u-ubootmod
          - xiaomi_mi-router-wr30u-112m-nmbm
          - xiaomi_redmi-router-ax6000
          - xiaomi_redmi-router-ax6000-stock
          - xiaomi_redmi-router-ax6000-ubootmod
          - cmcc_rax3000me
          # ... å¤åˆ¶ä½ å®Œæ•´çš„åž‹å·åˆ—è¡¨åˆ°è¿™é‡Œ ...
        default: cmcc_rax3000me
      custom_router_ip:
        description: "è¯·è®¾ç½®è·¯ç”±å™¨çš„ç®¡ç†åœ°å€ æ ¼å¼:192.168.x.1 æˆ– 10.x.x.1"
        required: true
        default: "192.168.6.1"
      enable_store:
        description: "é›†æˆ store å•†åº—"
        required: false
        type: boolean
        default: true
      include_docker:
        description: "æ˜¯å¦ç¼–è¯‘ Docker æ’ä»¶"
        required: true
        default: 'no'
        type: choice
        options:
          - 'yes'
          - 'no'
      enable_pppoe:
        description: "æ˜¯å¦é…ç½®PPPoEæ‹¨å·ä¿¡æ¯?"
        required: true
        default: 'no'
        type: choice
        options:
          - 'yes'
          - 'no'
      pppoe_account:
        description: "å®½å¸¦è´¦å· (è‹¥å¯ç”¨PPPoE)"
        required: false
      pppoe_password:
        description: "å®½å¸¦å¯†ç  (è‹¥å¯ç”¨PPPoE)"
        required: false

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y aria2 zstd

    - name: Download Official Kwrt ImageBuilder
      run: |
        mkdir -p ${{ github.workspace }}/kwrt-ib
        cd ${{ github.workspace }}/kwrt-ib
        echo "ðŸ“¥ ä¸‹è½½å®˜æ–¹ Kwrt ImageBuilder..."
        aria2c -q -x 16 -s 16 \
          https://dl.openwrt.ai/releases/24.10/targets/mediatek/filogic/kwrt-imagebuilder-mediatek-filogic.Linux-x86_64.tar.zst
        
        echo "ðŸ“¦ è§£åŽ‹ ImageBuilder..."
        tar --use-compress-program=unzstd -xf kwrt-imagebuilder-mediatek-filogic.Linux-x86_64.tar.zst
        ls -la

    - name: Copy custom files to ImageBuilder (ä¿ç•™æ‰€æœ‰DIYé…ç½®)
      run: |
        echo "ðŸ“‚ å¤åˆ¶æœ¬åœ°è‡ªå®šä¹‰æ–‡ä»¶åˆ° ImageBuilder..."
        cd ${{ github.workspace }}/kwrt-ib
        
        # åˆ›å»º files ç›®å½•ç»“æž„ï¼ˆImageBuilder æ ‡å‡†ï¼‰
        mkdir -p files/etc/config
        mkdir -p files/etc/uci-defaults
        mkdir -p shell
        
        # å¤åˆ¶ä½ çš„è‡ªå®šä¹‰æ–‡ä»¶ï¼ˆå®Œå…¨ä¿ç•™åŽŸæœ‰åŠŸèƒ½ï¼‰
        [[ -d "${{ github.workspace }}/custom" ]] && cp -rf ${{ github.workspace }}/custom/* files/etc/config/
        [[ -d "${{ github.workspace }}/shell" ]] && cp -rf ${{ github.workspace }}/shell/* shell/
        [[ -d "${{ github.workspace }}/glinet" ]] && cp -rf ${{ github.workspace }}/glinet/* files/etc/uci-defaults/
        [[ -f "${{ github.workspace }}/arch/arch.conf" ]] && cp ${{ github.workspace }}/arch/arch.conf files/etc/opkg/
        [[ -d "${{ github.workspace }}/devices" ]] && cp -rf ${{ github.workspace }}/devices/* files/
        [[ -d "${{ github.workspace }}/mediatek-filogic" ]] && cp -rf ${{ github.workspace }}/mediatek-filogic/*.sh shell/
        
        # ä¿å­˜è‡ªå®šä¹‰IPé…ç½®
        mkdir -p files/etc/config
        echo "${{ github.event.inputs.custom_router_ip }}" > files/etc/config/custom_router_ip.txt
        
        echo "âœ… è‡ªå®šä¹‰æ–‡ä»¶å¤åˆ¶å®Œæˆ"
        ls -la files/ shell/ 2>/dev/null || true

    - name: Prepare build packages list
      run: |
        # æ ¹æ®ç”¨æˆ·é€‰æ‹©å‡†å¤‡ PACKAGES åˆ—è¡¨
        PACKAGES=""
        if [ "${{ github.event.inputs.enable_store }}" == "true" ]; then
          PACKAGES="$PACKAGES luci-app-store"
        fi
        if [ "${{ github.event.inputs.include_docker }}" == "yes" ]; then
          PACKAGES="$PACKAGES docker dockerd luci-app-dockerman"
        fi
        
        # ä¿å­˜åˆ°çŽ¯å¢ƒå˜é‡
        echo "BUILD_PACKAGES=$PACKAGES" >> $GITHUB_ENV
        echo "Profile: ${{ github.event.inputs.profile }}"
        echo "Packages: $PACKAGES"
        echo "IP: ${{ github.event.inputs.custom_router_ip }}"

    - name: Build firmware with ImageBuilder
      working-directory: ${{ github.workspace }}/kwrt-ib
      run: |
        profile="${{ github.event.inputs.profile }}"
        packages="${{ env.BUILD_PACKAGES }}"
        pppoe_enabled="${{ github.event.inputs.enable_pppoe }}"
        pppoe_account="${{ github.event.inputs.pppoe_account }}"
        pppoe_password="${{ github.event.inputs.pppoe_password }}"
        
        echo "ðŸš€ å¼€å§‹ç¼–è¯‘: $profile"
        echo "ðŸ“¦ åŒ…åˆ—è¡¨: $packages"
        
        # ImageBuilder æ ‡å‡†ç¼–è¯‘å‘½ä»¤
        time make image \
          PROFILE="$profile" \
          PACKAGES="$packages" \
          FILES="files" \
          EXTRA_IMAGE_PACKAGES="" \
          DISABLED_SERVICES="odhcpd dnsmasq" \
          -j$(nproc) \
          V=s || make image PROFILE="$profile" PACKAGES="$packages" FILES="files" -j$(nproc)
        
        echo "âœ… ç¼–è¯‘å®Œæˆï¼"
        ls -la bin/targets/mediatek/filogic/

    - name: Create release info
      run: |
        cat > info.md << EOF
          # Kwrt 24.10.x å›ºä»¶ä¿¡æ¯
                  
          **åž‹å·**: ${{ github.event.inputs.profile }}
          **ç®¡ç†IP**: ${{ github.event.inputs.custom_router_ip }}
          **Docker**: ${{ github.event.inputs.include_docker == 'yes' && 'âœ… åŒ…å«' || 'âŒ ä¸åŒ…å«' }}
          **Store**: ${{ github.event.inputs.enable_store == 'true' && 'âœ… åŒ…å«' || 'âŒ ä¸åŒ…å«' }}
          **PPPoE**: ${{ github.event.inputs.enable_pppoe == 'yes' && 'âœ… å·²é…ç½®' || 'âŒ æœªé…ç½®' }}
          
          **å›ºä»¶æ–‡ä»¶**: bin/targets/mediatek/filogic/
          EOF
        
        cat info.md

    - name: Upload firmware as Release
      uses: softprops/action-gh-release@v2.2.1
      with:
        tag_name: ${{ github.event.inputs.profile }}-${{ github.run_number }}
        name: Kwrt-${{ github.event.inputs.profile }}
        body_path: info.md
        files: |
          ${{ github.workspace }}/kwrt-ib/bin/targets/mediatek/filogic/*.bin
          ${{ github.workspace }}/kwrt-ib/bin/targets/mediatek/filogic/*.img.gz
          ${{ github.workspace }}/kwrt-ib/bin/targets/mediatek/filogic/*.tar.gz
          ${{ github.workspace }}/kwrt-ib/bin/targets/mediatek/filogic/*.zst
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload firmware as artifact (å¤‡ç”¨ä¸‹è½½)
      uses: actions/upload-artifact@v4
      with:
        name: kwrt-${{ github.event.inputs.profile }}
        path: |
          ${{ github.workspace }}/kwrt-ib/bin/targets/mediatek/filogic/*
        retention-days: 7
