name: kwrt-imagebuilder

on:
  workflow_dispatch:
    inputs:
      profile:
        type: choice
        description: "è¯·é€‰æ‹©mtkè·¯ç”±å™¨åž‹å·"
        required: true
        options:
          # æ”¾å…¥ä½ çš„å®Œæ•´åž‹å·åˆ—è¡¨ï¼Œæ¯”å¦‚ï¼š
          - glinet_gl-mt2500
          - glinet_gl-mt3000
          - glinet_gl-mt6000
          - sl_3000-emmc
          # ... å…¶å®ƒåž‹å· ...
        default: sl_3000-emmc
      custom_router_ip:
        description: "è¯·è®¾ç½®è·¯ç”±å™¨çš„ç®¡ç†åœ°å€ æ ¼å¼:192.168.x.1 æˆ– 10.x.x.1"
        required: true
        default: "192.168.6.1"
      enable_store:
        description: "é›†æˆ store å•†åº—"
        required: false
        type: boolean
        default: true
      include_docker:
        description: "æ˜¯å¦ç¼–è¯‘ Docker æ’ä»¶"
        required: true
        default: 'no'
        type: choice
        options:
          - 'yes'
          - 'no'
      enable_pppoe:
        description: "æ˜¯å¦é…ç½®PPPoEæ‹¨å·ä¿¡æ¯?"
        required: true
        default: 'no'
        type: choice
        options:
          - 'yes'
          - 'no'
      pppoe_account:
        description: "å®½å¸¦è´¦å· (è‹¥å¯ç”¨PPPoE)"
        required: false
      pppoe_password:
        description: "å®½å¸¦å¯†ç  (è‹¥å¯ç”¨PPPoE)"
        required: false

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install aria2 and zstd
      run: |
        sudo apt-get update
        sudo apt-get install -y aria2 zstd

    - name: Download Kwrt Official ImageBuilder
      run: |
        mkdir -p ${{ github.workspace }}/kwrt-ib
        cd ${{ github.workspace }}/kwrt-ib
        aria2c -q https://dl.openwrt.ai/releases/24.10/targets/mediatek/filogic/kwrt-imagebuilder-mediatek-filogic.Linux-x86_64.tar.zst
        tar --use-compress-program=unzstd -xf kwrt-imagebuilder-mediatek-filogic.Linux-x86_64.tar.zst
        ls -lh

    - name: Copy custom files to ImageBuilder (correct directory structure)
      run: |
        cd ${{ github.workspace }}/kwrt-ib

        echo "ðŸ“‚ Creating required directories..."
        mkdir -p files/etc/config files/etc/uci-defaults files/etc/opkg shell files/devices

        echo "ðŸ“‚ Copying custom files..."
        if [ -d "${{ github.workspace }}/custom" ]; then
          cp -rf ${{ github.workspace }}/custom/* files/etc/config/
        fi

        if [ -d "${{ github.workspace }}/shell" ]; then
          cp -rf ${{ github.workspace }}/shell/* shell/
        fi

        if [ -d "${{ github.workspace }}/glinet" ]; then
          cp -rf ${{ github.workspace }}/glinet/* files/etc/uci-defaults/
        fi

        if [ -f "${{ github.workspace }}/arch/arch.conf" ]; then
          cp ${{ github.workspace }}/arch/arch.conf files/etc/opkg/
        fi

        if [ -d "${{ github.workspace }}/devices" ]; then
          cp -rf ${{ github.workspace }}/devices/* files/devices/
        fi

        if [ -d "${{ github.workspace }}/mediatek-filogic" ]; then
          cp -rf ${{ github.workspace }}/mediatek-filogic/*.sh shell/
        fi

        echo "âœ… Custom files copied:"
        ls -l files/etc/config/
        ls -l shell/
        ls -l files/etc/opkg/

    - name: Prepare build packages list
      run: |
        PACKAGES=""
        if [ "${{ github.event.inputs.enable_store }}" == "true" ]; then
          PACKAGES="$PACKAGES luci-app-store"
        fi
        if [ "${{ github.event.inputs.include_docker }}" == "yes" ]; then
          PACKAGES="$PACKAGES docker dockerd luci-app-dockerman"
        fi
        echo "PACKAGES=\"$PACKAGES\"" >> $GITHUB_ENV

    - name: Build ImageBuilder firmware
      working-directory: ${{ github.workspace }}/kwrt-ib
      run: |
        PROFILE="${{ github.event.inputs.profile }}"
        echo "âš™ï¸ Building firmware for profile: $PROFILE"
        echo "ðŸ“¦ Including packages: $PACKAGES"

        make image PROFILE="$PROFILE" PACKAGES="$PACKAGES" FILES="files" -j$(nproc)
        echo "âœ… Build finished"
        ls -lh bin/targets/mediatek/filogic/

    - name: Create release info
      run: |
        cat > info.md <<EOF
        # Kwrt 24.10.x Build Info  
        
        - Profile: ${{ github.event.inputs.profile }}
        - Router IP: ${{ github.event.inputs.custom_router_ip }}
        - Enable Store: ${{ github.event.inputs.enable_store }}
        - Include Docker: ${{ github.event.inputs.include_docker }}
        - Enable PPPoE: ${{ github.event.inputs.enable_pppoe }}
        
        å›ºä»¶å­˜æ”¾è·¯å¾„ï¼šbin/targets/mediatek/filogic/
        EOF
        cat info.md

    - name: Upload firmware to release
      uses: softprops/action-gh-release@v2.2.1
      with:
        tag_name: ${{ github.event.inputs.profile }}-${{ github.run_number }}
        name: Kwrt-${{ github.event.inputs.profile }}
        body_path: info.md
        files: |
          ${{ github.workspace }}/kwrt-ib/bin/targets/mediatek/filogic/*.bin
          ${{ github.workspace }}/kwrt-ib/bin/targets/mediatek/filogic/*.img.gz
          ${{ github.workspace }}/kwrt-ib/bin/targets/mediatek/filogic/*.tar.gz
          ${{ github.workspace }}/kwrt-ib/bin/targets/mediatek/filogic/*.zst
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload firmware artifact (for backup)
      uses: actions/upload-artifact@v4
      with:
        name: kwrt-${{ github.event.inputs.profile }}
        path: ${{ github.workspace }}/kwrt-ib/bin/targets/mediatek/filogic/
        retention-days: 7
