name: kwrt-imagebuilder

on:
  workflow_dispatch:
    inputs:
      profile:
        type: choice
        description: "è¯·é€‰æ‹©mtkè·¯ç”±å™¨åž‹å·"
        required: true
        options:
          - cmcc_rax3000me
          - cudy_tr3000-v1
          - jcg_q30-pro
          - sl_3000-emmc
          # æ·»åŠ æ›´å¤šåž‹å·...
        default: sl_3000-emmc
      custom_router_ip:
        description: "è¯·è®¾ç½®è·¯ç”±å™¨çš„ç®¡ç†åœ°å€ æ ¼å¼:192.168.x.1 æˆ– 10.x.x.1"
        required: true
        default: "192.168.6.1"
      enable_store:
        description: "é›†æˆ store å•†åº—"
        required: false
        type: boolean
        default: true
      include_docker:
        description: "æ˜¯å¦ç¼–è¯‘ Docker æ’ä»¶"
        required: true
        default: 'no'
        type: choice
        options:
          - 'yes'
          - 'no'

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y aria2 zstd

    - name: Download Kwrt Official ImageBuilder
      run: |
        mkdir -p ${{ github.workspace }}/kwrt-ib
        cd ${{ github.workspace }}/kwrt-ib
        #aria2c -q https://dl.openwrt.ai/releases/24.10/targets/mediatek/filogic/kwrt-imagebuilder-mediatek-filogic.Linux-x86_64.tar.zst
        aria2c -q https://github.com/1303045940/Kwrt/releases/download/12%2F04_2025_02%2F29_mediatek_filogic/kwrt-imagebuilder-mediatek-filogic.Linux-x86_64.tar.zst

        tar --use-compress-program=unzstd -xf kwrt-imagebuilder-mediatek-filogic.Linux-x86_64.tar.zst
        ls -lh .

    - name: Copy custom files
      run: |
        cd ${{ github.workspace }}/kwrt-ib/kwrt-imagebuilder-mediatek-filogic.Linux-x86_64
        
        echo "ðŸ“‚ Creating directories..."
        mkdir -p files/etc/config files/etc/uci-defaults files/etc/opkg shell
        
        echo "ðŸ“‚ Copying custom files..."
        [[ -d "${{ github.workspace }}/custom" ]] && cp -rf ${{ github.workspace }}/custom/* files/etc/config/ 2>/dev/null || echo "No custom dir"
        [[ -d "${{ github.workspace }}/shell" ]] && cp -rf ${{ github.workspace }}/shell/* shell/ 2>/dev/null || echo "No shell dir"
        [[ -f "${{ github.workspace }}/arch/arch.conf" ]] && cp ${{ github.workspace }}/arch/arch.conf files/etc/opkg/ 2>/dev/null || echo "No arch.conf"
        
        echo "âœ… Files ready"
        find files -type f | head -10

    - name: Prepare packages
      run: |
        PACKAGES=""
        if [ "${{ github.event.inputs.enable_store }}" == "true" ]; then
          PACKAGES="luci-app-store"
        fi
        if [ "${{ github.event.inputs.include_docker }}" == "yes" ]; then
          PACKAGES="$PACKAGES docker dockerd luci-app-dockerman"
        fi
        echo "PACKAGES=$PACKAGES" >> $GITHUB_ENV

    - name: Build firmware (Fixed ImageBuilder command)
      working-directory: ${{ github.workspace }}/kwrt-ib/kwrt-imagebuilder-mediatek-filogic.Linux-x86_64
      run: |
        PROFILE="${{ github.event.inputs.profile }}"
        PACKAGES="${{ env.PACKAGES }}"
        
        echo "ðŸ”¨ Available make targets:"
        make help | grep -E "(image|sysupgrade|factory)"
        
        echo "ðŸ“‹ Profile list:"
        make info
        
        echo "ðŸš€ Building $PROFILE with packages: $PACKAGES"
        
        # ImageBuilder æ ‡å‡†å‘½ä»¤
        make image PROFILE="$PROFILE" PACKAGES="$PACKAGES" FILES="files" -j$(nproc) || {
          echo "Primary build failed, trying basic build..."
          make image PROFILE="$PROFILE" FILES="files" -j$(nproc)
        }
        
        echo "âœ… SUCCESS!"
        ls -lh bin/targets/mediatek/filogic/

    - name: Create release info
      run: |
        cat > ${{ github.workspace }}/info.md << EOF
          # Kwrt 24.10.x Firmware
                  
          **Profile**: ${{ github.event.inputs.profile }}
          **IP**: ${{ github.event.inputs.custom_router_ip }}
          **Store**: ${{ github.event.inputs.enable_store == 'true' && 'âœ…' || 'âŒ' }}
          **Docker**: ${{ github.event.inputs.include_docker == 'yes' && 'âœ…' || 'âŒ' }}
          
          **Files**: bin/targets/mediatek/filogic/
          EOF

    - name: Upload Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.event.inputs.profile }}-${{ github.run_number }}
        name: Kwrt-${{ github.event.inputs.profile }}
        body_path: ${{ github.workspace }}/info.md
        files: |
          ${{ github.workspace }}/kwrt-ib/kwrt-imagebuilder-mediatek-filogic.Linux-x86_64/bin/targets/mediatek/filogic/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: kwrt-${{ github.event.inputs.profile }}
        path: ${{ github.workspace }}/kwrt-ib/kwrt-imagebuilder-mediatek-filogic.Linux-x86_64/bin/targets/mediatek/filogic/*

